The logsumexp is borrowed from https://github.com/rmcgibbo/logsumexp for speed.
